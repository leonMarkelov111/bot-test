require('dotenv').config()
const fs = require('fs');
global.userRight = require('./src/configs/globalUserRights.json')
//======================================================================================================================
const logger = require('./src/logger')
const func = require("./src/func");

const {VK} = require('vk-io');
const messages = require("./message.json");
const {checkUserInBlackList} = require("./src/func");
global.vk = new VK({
    token: '15d9aebf775afd74b7ff699e66edb5059b81bba904fb6873fe27c5532fc0a775d28f5f89e794c934789f5',
    pollingGroupId: 208831405,
    apiMode: 'parallel'
});

//====================== MongoDB ===========================================================
global.mongoose = require('mongoose');
mongoose.connect('mongodb+srv://vlad:kabasik1@database.ynauq.mongodb.net/data?retryWrites=true&w=majority').then(() => logger.info.info("ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” - ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"))

// ÐžÐ±ÑŠÑÐ²Ð»ÑÐµÐ¼ Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°Ð¼Ð¸

const cmds = fs
    .readdirSync(`${__dirname}/cmds/`)
    .filter((name) => /\.js$/i.test(name))
    .map((name) => require(`${__dirname}/cmds/${name}`));

const lsCmds = fs
    .readdirSync(`${__dirname}/lsCmds/`)
    .filter((name) => /\.js$/i.test(name))
    .map((name) => require(`${__dirname}/lsCmds/${name}`));

// ÐšÐ¾Ð½ÑÐ¾Ð»Ð¸Ð¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
logger.info.info("Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»ÑÑ.")

// (Polling)
vk.updates.start()
    .catch(logger.info.info)


//================== SCENE ===========================
const {SessionManager} = require('@vk-io/session')
const {SceneManager} = require('@vk-io/scenes')

const {
    mainMenuScene,
    adminBotMenu,
    setBotAdmin
} = require('./src/scenes/')

const sessionManager = new SessionManager({
    getStorageKey: (msg) => String(msg.peerId)
});
const sceneManager = new SceneManager()


sceneManager.addScenes(mainMenuScene)
sceneManager.addScenes(adminBotMenu)
sceneManager.addScenes(setBotAdmin)
//================== SCENE END ===========================

vk.updates.on('message_new', sessionManager.middleware)
vk.updates.on('message_new', sceneManager.middleware)
vk.updates.on('message_new', sceneManager.middlewareIntercept)

vk.updates.on(['message_new'], async (msg) => {
    if (msg.isOutbox) {
        return;
    }

    msg.answer = (text = "", params = {}) => {
        const result = `${text}`;
        return msg.send(result, params);
    };
    msg.ok = (text = "", params = {}) => {
        return msg.answer('ðŸ‘ ' + text, params);
    };
    msg.error = (text = "", params = {}) => {
        return msg.answer('âœ– ' + text, params);
    };


    if (msg.peerType === 'chat') {
        logger.trace.trace(`[${msg.peerId}]: ${msg.senderId} | ${msg.text}`)
        let convInfo = await func.getConvInfo(msg.peerId)
        let userProfile
        if(convInfo.status !== undefined) {
            if (convInfo.status === 1) {
                userProfile = await func.convUserAdd(msg, msg.senderId, msg.peerId);
                if(convInfo.silence >= 1 && userProfile.admin < 1) {
                    await msg.deleteMessage({
                        "delete_for_all": 1,
                        "conversation_message_ids": msg.conversationMessageId,
                        "peer_id": msg.peerId
                    })
                }
                if(userProfile.mute) {
                    await msg.deleteMessage({
                        "delete_for_all": 1,
                        "conversation_message_ids": msg.conversationMessageId,
                        "peer_id": msg.peerId
                    })
                    await func.addUserMuteWarn(msg.senderId, msg.peerId)
                    if(userProfile.muteWarning + 1 === 3) {
                        await msg.send(`@id${msg.senderId}(ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ) Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ 3 Ð¸Ð· 3 Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ð¹ Ð·Ð° Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ñ‡Ð°Ñ‚Ðµ, Ð½Ð°Ñ…Ð¾Ð´ÑÑÑŒ Ð² Ð¼ÑƒÑ‚Ðµ.`)
                        await func.kickUserFromChat(msg.peerId, msg.senderId)
                        await func.deleteUserMuteWarn(msg.peerId, msg.senderId)
                    } else {
                        await msg.send(`@id${msg.senderId}(ÐÐ°Ñ€ÑƒÑˆÐ¸Ñ‚ÐµÐ»ÑŒ), ÐµÑÐ»Ð¸ Ñ‚Ñ‹ Ð±ÑƒÐ´ÐµÑˆÑŒ Ð¿Ñ‹Ñ‚Ð°Ñ‚ÑŒÑÑ Ñ„Ð»ÑƒÐ´Ð¸Ñ‚ÑŒ Ð² Ð¼ÑƒÑ‚Ðµ - Ñ‚Ñ‹ Ð±ÑƒÐ´ÐµÑˆÑŒ ÐºÐ¸ÐºÐ½ÑƒÑ‚.\nÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ: ${userProfile.muteWarning + 1} Ð¸Ð· 3!`)
                    }
                }
            }
        } else {
            return msg.send(`ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð±ÐµÑÐµÐ´Ñ‹. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑÐ¸Ñ‚ÑŒ ÐµÑ‰Ñ‘ Ñ€Ð°Ð· Ð±Ð¾Ñ‚Ð° Ð² Ð±ÐµÑÐµÐ´Ñƒ!`)
        }

        let cmd = cmds.find(cmd => cmd.regexp ? cmd.regexp.test(msg.text) : (new RegExp(`^\\s*(${cmd.tag.join('|')})`, "i")).test(msg.text) && cmd.tagWork === 'user');
        if (!cmd) {
            return true;
        } else {
            try {
                //console.log(userProfile)
                await cmd.func(msg, {cmds, vk, VK, cmd, userProfile, convInfo});
            } catch (e) {
                logger.error.error(`ÐžÑˆÐ¸Ð±ÐºÐ°:\n${e.message}`);
                msg.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ '${msg.text}'`);
            }
        }
    } else {
        let cmd = lsCmds.find(cmd => cmd.regexp ? cmd.regexp.test(msg.text) : (new RegExp(`^\\s*(${cmd.tag.join('|')})`, "i")).test(msg.text) && cmd.tagWork === 'user');
        if (!cmd) {
            if (!msg.scene.current) {
                await msg.scene.enter('mainMenuScene')
            }
        } else {
            await msg.scene.leave({
                silent: true,
                canceled: true
            });

            try {
                await cmd.func(msg, {cmds, vk, VK, cmd});
            } catch (e) {
                logger.error.error(`ÐžÑˆÐ¸Ð±ÐºÐ°:\n${e.message}`);
                msg.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ '${msg.text}'`);
            }
        }
    }
    //await func.checkConvUserInDB(msg, msg.senderId, msg.peerId, 1);
})


vk.updates.on(['chat_invite_user', 'chat_invite_user_by_link'], async (msg) => {
    //console.log('[DEBUG] Ð¡Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» chat_invite_user Ð¸Ð»Ð¸ chat_invite_user_by_link'.green.bold)
    logger.info.info(`Ð¡Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» chat_invite_user Ð¸Ð»Ð¸ chat_invite_user_by_link`)
    //logger.info(msg)

    if (msg.eventMemberId === -208831405) {
        await func.convDelete(msg.peerId)
        await msg.send(`ÐŸÑ€Ð¸Ð²ÐµÑ‚! ÐŸÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³ Ñ‚Ñ‹ ÑÐ´ÐµÐ»Ð°Ð» - Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ñ‚ÐµÐ±Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð° Ð² ÑÑ‚Ð¾Ð¹ Ð±ÐµÑÐµÐ´Ðµ.\n\nÐ”Ð»Ñ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð´Ð°Ð¹ Ð¼Ð½Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð² Ð±ÐµÑÐµÐ´Ðµ, Ð° Ð·Ð°Ñ‚ÐµÐ¼ Ð²Ð²ÐµÐ´Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /botstart`);
        await func.convAdd(msg.peerId)
    } else {
        let convInfo = await func.getConvInfo(msg.peerId)
        if(convInfo === false) return true;

        let userID = msg.eventMemberId
        if (msg.eventType === "chat_invite_user_by_link") {
            userID = msg.senderId
        }

        let userInfo = await checkUserInBlackList(userID)
        if(userInfo) {
            await msg.send(`@id${userID}(ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ) Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒÑÑ Ð² Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ð¼ Ð§Ð¡!\nÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð·Ð°Ð½ÐµÑÐµÐ½Ð¸Ñ Ð² Ð§Ð¡: ${userInfo.reason}`);
            return await func.kickUserFromChat(msg.peerId, userID);
        }

        let user = await func.convUserAdd(msg, userID, msg.peerId);
        if (user.ban) {
            await msg.send('ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒÑÑ Ð² Ð±Ð°Ð½Ðµ!');
            return await func.kickUserFromChat(msg.peerId, userID);
        }

        //let vkUserInfo = await func.getUserInfo(msg, userID);
        //await func.sendHelloMessage(msg, userInfo);
        //await func.checkUserBan(msg, msg.eventMemberId, await func.getUserBan(msg, msg.eventMemberId))
    }
    //console.log(msg)
})


vk.updates.on(['chat_kick_user'], async (msg) => {
    await func.deleteUserMuteWarn(msg.senderId, msg.peerId)
    return await func.kickUserFromChat(msg.peerId, msg.senderId)
})


// ÐšÐ¾Ð½ÑÐ¾Ð»Ð¸Ð¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
process.on("uncaughtException", e => {
    logger.error.error(e);
});

process.on("unhandledRejection", e => {
    logger.error.error(e);
});

setInterval(async () => {
    await func.muteTimeCheck();
}, 60000);

// setInterval(async () => {
//     let convArray = await func.getConvs();
//
//     console.log(convArray)
//     for (let i = 0; i < convArray.lenght; i++) {
//         console.log(convArray[i])
//         await func.checkConvUsersInDB(convArray[i].convID)
//     }
//
// }, 30000);
